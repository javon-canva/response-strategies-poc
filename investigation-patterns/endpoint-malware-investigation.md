# Endpoint Malware Investigation Pattern

## Overview

**Pattern Type:** Malware Analysis  
**Applicable Incident Types:** Malware Detection, Suspicious Process Activity, Data Exfiltration, Ransomware  
**Version:** 1.0  
**Last Updated:** 2025-07-25  
**Maintainer:** Detection & Response Team

## Pattern Description

This investigation pattern provides a structured approach for analyzing malware detected on endpoints. It applies to all types of malware incidents including commodity malware, targeted attacks, ransomware, and potentially unwanted applications (PUAs). The pattern focuses on understanding malware behavior, determining its capabilities and impact, identifying its origin, and assessing the scope of compromise across the environment.

## Pre-Investigation Steps

### Data Source Preparation

1. **Identify Required Data Sources**
   - [SentinelOne Deep Visibility](../../data-source-procedures/sentinelone-deep-visibility.md)
   - [Endpoint Forensic Analysis](../../data-source-procedures/endpoint-forensic-analysis.md)
   - [Firewall Logs](../../data-source-procedures/firewall-logs-analysis.md)
   - [Proxy Logs](../../data-source-procedures/proxy-logs-analysis.md)
   - [Email Security Logs](../../data-source-procedures/email-security-logs.md)

2. **Verify Data Availability**
   - Ensure SentinelOne agent is active on the affected endpoint
   - Check that Deep Visibility data collection is enabled and functioning
   - Verify that relevant time period is within data retention window
   - Confirm access to additional log sources for correlation

3. **Prepare Investigation Environment**
   - Set up secure analysis environment for malware samples
   - Configure analysis tools (static and dynamic analysis tools)
   - Prepare documentation templates for tracking findings
   - Establish secure communication channel with affected users

## Investigation Methodology

### Phase 1: Process Analysis

**Purpose:** Understand the malicious process execution chain and behavior

**Steps:**
1. Analyze the process execution chain:
   ```
   // Query for the malicious process and its lineage
   EventType = "Process Creation" AND 
   (ProcessName = "malicious.exe" OR SHA1 = "abc123...") AND
   TimestampUTC >= "2025-07-20T00:00:00Z" AND
   TimestampUTC <= "2025-07-25T00:00:00Z"
   ```

2. Examine process tree visualization:
   - Identify the parent process that spawned the malware
   - Map all child processes created by the malware
   - Look for unusual parent-child relationships (e.g., Office applications spawning PowerShell)
   - Analyze process command line arguments for suspicious parameters

3. Review process behaviors:
   - Check for process injection techniques
   - Identify attempts to escalate privileges
   - Look for defense evasion tactics (e.g., disabling security tools)
   - Examine persistence mechanisms (e.g., registry modifications, scheduled tasks)

4. Analyze file operations:
   - Check for file creation in unusual locations
   - Look for access to sensitive files or directories
   - Identify file encryption patterns (for ransomware)
   - Monitor for large file reads indicative of data collection

**Expected Outcomes:**
- Complete understanding of malware execution flow
- Identification of malicious behaviors and techniques
- Detection of persistence mechanisms
- Classification of malware type and family

**Pivot Points:**
- If ransomware indicators are found, pivot to ransomware-specific investigation
- If data collection is observed, pivot to data exfiltration analysis
- If lateral movement is detected, expand scope to network activity analysis
- If advanced techniques are observed, consider targeted attack investigation

### Phase 2: Network Activity Analysis

**Purpose:** Identify external communications and potential command and control (C2) channels

**Steps:**
1. Analyze network connections:
   ```
   // Query for network connections from malicious process
   EventType = "Network" AND 
   (ProcessName = "malicious.exe" OR ParentName = "malicious.exe") AND
   Direction = "Outbound" AND
   TimestampUTC >= "2025-07-20T00:00:00Z" AND
   TimestampUTC <= "2025-07-25T00:00:00Z"
   ```

2. Examine DNS requests:
   - Identify all domain lookups from infected endpoint
   - Check for domain generation algorithm (DGA) patterns
   - Analyze for DNS tunneling indicators
   - Compare against known malicious domains

3. Evaluate connection patterns:
   - Look for beaconing behavior to C2 servers
   - Check for connections to unusual ports or protocols
   - Identify connections to known malicious IP addresses
   - Analyze data volume to detect exfiltration

4. Correlate with proxy and firewall logs:
   - Match outbound connections with proxy/firewall records
   - Check for blocked connections that may indicate attempted malicious activity
   - Look for successful connections that bypassed security controls

**Expected Outcomes:**
- Identification of command and control infrastructure
- Detection of data exfiltration attempts
- Understanding of communication patterns
- List of external entities involved in the attack

**Pivot Points:**
- If data exfiltration is confirmed, pivot to data impact assessment
- If multiple C2 servers are identified, expand search for additional indicators
- If communication with known threat actor infrastructure is found, pivot to threat actor analysis
- If DNS tunneling is detected, focus on data exfiltration techniques

### Phase 3: Initial Infection Vector Analysis

**Purpose:** Determine how the malware entered the environment

**Steps:**
1. Review recent file creation events:
   ```
   // Query for file creation events prior to malware execution
   EventType = "File Creation" AND 
   TimestampUTC >= "2025-07-19T00:00:00Z" AND
   TimestampUTC <= "2025-07-20T00:00:00Z" AND
   EndpointName = "AFFECTED-HOST"
   ```

2. Examine email attachments and links:
   - Check email security logs for delivered malicious content
   - Look for phishing indicators in recent emails
   - Correlate email receipt with malware execution time
   - Review user-clicked links leading to malicious downloads

3. Analyze browser and download activity:
   - Check browser history for suspicious websites
   - Review download events preceding infection
   - Look for drive-by download indicators
   - Examine browser plugin/extension activity

4. Investigate removable media and lateral movement:
   - Check for USB device connections prior to infection
   - Look for network share access events
   - Examine remote execution attempts from other endpoints
   - Review user authentication events across systems

**Expected Outcomes:**
- Identification of initial infection vector
- Timeline of events leading to compromise
- Understanding of attack delivery mechanism
- Assessment of user awareness and training needs

**Pivot Points:**
- If phishing is identified, pivot to email security analysis
- If drive-by download is found, focus on web security controls
- If lateral movement was the vector, expand to network segmentation review
- If supply chain compromise is detected, initiate vendor security assessment

### Phase 4: Scope and Impact Assessment

**Purpose:** Determine the full extent of the compromise and potential impact

**Steps:**
1. Search for similar indicators across the environment:
   ```
   // Query for the same malware across all endpoints
   (SHA1 = "abc123..." OR ProcessName = "malicious.exe" OR 
   CommandLine CONTAINS "suspicious parameter") AND
   TimestampUTC >= "2025-07-15T00:00:00Z"
   ```

2. Identify affected assets:
   - Create inventory of all compromised endpoints
   - Determine criticality of affected systems
   - Identify users whose accounts were involved
   - Map affected data and applications

3. Assess data impact:
   - Determine if sensitive data was accessed
   - Check for evidence of data exfiltration
   - Quantify volume and types of data potentially exposed
   - Evaluate regulatory and compliance implications

4. Evaluate business impact:
   - Assess operational disruption
   - Determine financial impact
   - Identify reputational risks
   - Evaluate recovery time requirements

**Expected Outcomes:**
- Complete list of affected systems and accounts
- Assessment of data compromise
- Understanding of business impact
- Prioritization for containment and remediation

**Pivot Points:**
- If widespread infection is found, initiate enterprise-wide response
- If sensitive data was accessed, pivot to data breach procedures
- If critical systems are affected, focus on business continuity
- If minimal impact is confirmed, proceed to targeted remediation

## Data Correlation Techniques

### Technique 1: Malware Execution Timeline Analysis

**Purpose:** Create a comprehensive timeline of malware activity from initial infection to detection

**Implementation:**
1. Collect timestamp data from all relevant events:
   - Initial file creation/download events
   - Process execution events
   - Network connection attempts
   - Registry and file system modifications
   - Security control alerts and logs

2. Order events chronologically to visualize the attack chain:
   ```
   // Example approach for timeline creation
   $download = EventType = "File Creation" AND FilePath CONTAINS "Downloads";
   $execution = EventType = "Process Creation" AND ProcessName = "malicious.exe";
   $network = EventType = "Network" AND ProcessName = "malicious.exe";
   $persistence = EventType = "Registry" AND ProcessName = "malicious.exe";
   
   $download | followed by $execution | followed by $network | followed by $persistence
   ```

3. Identify gaps in the timeline that require additional investigation

**Example:**
```
09:15:32 - User receives phishing email with attachment (Email Security Log)
09:17:45 - User downloads attachment "invoice.xlsx" (Web Proxy Log)
09:18:03 - Excel process launches (SentinelOne)
09:18:12 - PowerShell spawned by Excel with encoded command (SentinelOne)
09:18:15 - Malware payload written to temp directory (SentinelOne)
09:18:20 - Malware establishes persistence via registry key (SentinelOne)
09:19:05 - First C2 connection attempt to malicious domain (SentinelOne/Firewall)
```

### Technique 2: Cross-System Correlation

**Purpose:** Identify related activity across multiple systems to understand malware propagation

**Implementation:**
1. Use common indicators to search across all endpoints:
   - Hash values of malware files
   - Command line patterns
   - Network destinations
   - Registry modifications

2. Create a network map showing connections between affected systems:
   ```
   // Find connections between affected systems
   $source_systems = EndpointName IN ("AFFECTED-HOST-1", "AFFECTED-HOST-2");
   $target_systems = IPAddress IN (internal_subnet_range);
   
   $source_systems AND $target_systems AND Direction = "Outbound"
   ```

3. Correlate user authentication events with malware activity

**Example:**
```
- System A shows initial infection at 09:18:15
- User account login to System B at 09:45:22
- Similar malware detected on System B at 09:46:17
- SMB connections from System B to Systems C and D at 09:58:33
- Similar malware signatures on Systems C and D at 10:05:12
```

### Technique 3: MITRE ATT&CK Mapping

**Purpose:** Map observed behaviors to known tactics, techniques, and procedures (TTPs)

**Implementation:**
1. Document all observed malware behaviors
2. Map behaviors to MITRE ATT&CK techniques
3. Compare against known threat actor profiles
4. Identify patterns that suggest specific malware families

**Example:**
```
- PowerShell with Base64 encoding [T1059.001: Command and Scripting Interpreter: PowerShell]
- Scheduled Task creation [T1053.005: Scheduled Task/Job: Scheduled Task]
- Connection to uncommon ports [T1571: Non-Standard Port]
- Registry Run key modification [T1547.001: Boot or Logon Autostart Execution: Registry Run Keys]
- Pattern matches EMOTET malware family behaviors
```

## Investigation Artifacts

### Required Artifacts

- **Malware Execution Timeline**: Chronological record of all malware activity
- **Process Tree Analysis**: Visual representation of process relationships
- **Network Communication Map**: Documentation of all external connections
- **Affected Asset Inventory**: Complete list of compromised systems and accounts
- **Malware Capability Assessment**: Analysis of malware functionality and purpose

### Optional Artifacts

- **MITRE ATT&CK Mapping**: Correlation of behaviors to attack framework
- **Malware Sample Analysis**: Static and dynamic analysis results of malware samples
- **User Interview Notes**: Documentation from discussions with affected users
- **Remediation Recommendations**: Specific guidance for eradicating the malware

## Common False Positives

| Scenario | Indicators | How to Verify |
|----------|-----------|---------------|
| Security Software | High resource usage, many file accesses, network connections to security vendors | Check process signer information; Verify against known security tool processes; Confirm with standard security toolset inventory |
| Developer Tools | Unusual processes, scripting activity, network connections to code repositories | Check user role/department; Verify against known development tools; Confirm with user or development team |
| System Administration Tools | PowerShell scripts, remote connections, administrative actions | Correlate with change management records; Check if user is in IT/admin group; Verify timing against maintenance windows |
| Benign PUAs | Alerts for unwanted applications, advertising connections | Check company software policy; Examine actual behavior for malicious indicators; Verify software reputation through threat intelligence |

## Investigation Completion Criteria

### Required Findings

- Clear identification of malware type and family
- Complete understanding of infection vector
- Full scope of affected systems and accounts
- Assessment of data access and potential exfiltration
- Determination of business impact
- Recommendations for containment and eradication

### Required Documentation

- Detailed timeline of malware activity
- Evidence supporting attribution to specific malware family
- List of all affected systems and remediation status
- Assessment of data exposure and potential breach implications
- Recommendations to prevent similar incidents in the future

## Related SOPs

- [Malware Incident Response SOP](../../sops/malware-incident-response-sop.md)
- [Endpoint Isolation Procedure](../../sops/endpoint-isolation-procedure-sop.md)
- [Data Breach Response SOP](../../sops/data-breach-response-sop.md)

## Additional Resources

- [MITRE ATT&CK Framework](https://attack.mitre.org/)
- [SentinelOne Threat Hunting Guide](https://community.sentinelone.com/s/article/Threat-Hunting-Guide)
- [Malware Analysis Fundamentals](https://www.sans.org/reading-room/whitepapers/malicious/paper/39282)
- [Common Malware Types](https://www.cisa.gov/topics/addressing-threats/malware)