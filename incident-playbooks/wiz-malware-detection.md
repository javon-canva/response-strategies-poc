# Wiz Malware Detection Incident Playbook

## Overview

**Incident Type:** Cloud Workload Malware Detection  
**Severity Levels:** Low/Medium/High/Critical  
**Response Team:** Detection & Response Team  
**Version:** 1.0  
**Last Updated:** 2025-07-25  
**Maintainer:** Detection & Response Team

## Detection Sources

- [Wiz Security Platform](https://app.wiz.io/)
- [Detection Strategy](https://www.canva.com/design/DAGBy3roWdM/GBMYWsuZe5cFnold19SSRQ/edit)
- [Previous Response Examples](https://pew-pew.canva-internal.com/caseview/ca3af779-bce6-4e34-953e-6a6f79f5ab1a)

## Response Strategy

### Assumptions

- Access to the Wiz security platform with appropriate permissions
- Access to AWS forensic environments
- Understanding of cloud workload security concepts
- Familiarity with malware analysis techniques

### Considerations

- Cloud workload infections can spread rapidly across connected resources
- Some detections may be related to vulnerable libraries rather than actual malware
- The `analyst_sample_override` reason often indicates a vulnerable component rather than active malware
- Forensic analysis capabilities may vary depending on cloud provider and resource type
- Containment actions can impact production workloads and should be coordinated with resource owners

## Triage

### Initial Assessment

1. Identify the affected cloud resource:
   - Note the affected resource under the **Affected Resource** header in the Cydarm case
   - If the issue is active, locate it in the Wiz console via the **See alert in console** hyperlink
   - Document the resource type, ID, and cloud environment (AWS, GCP, etc.)
   - Identify the resource owner and business function

2. Analyze the malware detection:
   - View the malware instances under the Evidence header in Cydarm or as nodes connected to the affected resource in the Wiz graph
   - Document each malware instance detected by Wiz, including:
     - Description of the malware
     - File path on the affected resource
     - Hash information (MD5, SHA1, SHA256)
     - Detection reason (e.g., `analyst_sample_override`, `signature_match`)
   - Check the hash of the suspected malware on OSINT platforms like VirusTotal and Anomali

3. Evaluate contextual information:
   - Check if the file is part of a vulnerable library/package rather than actively malicious code
   - Review the Wiz graph to identify connected resources that could be affected
   - Determine if the file has successfully executed based on available evidence
   - Assess the resource's role and connectivity to understand potential impact

### Severity Assessment Criteria

| Severity | Criteria |
|----------|----------|
| Critical | Confirmed execution of ransomware or data destructive malware; Active malware in production environment with sensitive data; Evidence of data exfiltration from critical resources; Lateral movement observed across multiple cloud resources | 
| High     | Confirmed malware execution on production system; Malware with backdoor or remote access capabilities; Suspicious network connections established; Evidence of potential data access |
| Medium   | Detected malware without confirmation of execution; Known malware signature on non-critical system; Vulnerable components with exploitation potential; Limited access to sensitive data |
| Low      | False positive indicators; Vulnerable library without active exploitation; Isolated instance with minimal impact potential; Legacy malware signatures in backups or archives |

### Validation Criteria

Escalate to an incident if any of the following are true:
- Confirmed malware execution on cloud resource
- Multiple detections across related resources
- Presence of known malicious indicators verified by threat intelligence
- Evidence of lateral movement or data access attempts
- Critical or production resource affected
- Unusual network activity originating from the affected resource

## Investigation

### Investigation Pattern

Follow the [Endpoint Malware Investigation Pattern](../../investigation-patterns/endpoint-malware-investigation.md) for this incident type, adapting as needed for cloud environments.

### Data Sources

Use these data source procedures to gather evidence:
- [Cloud Forensics Analysis](../../data-source-procedures/cloud-forensics-analysis.md)
- [Cloud Audit Log Investigation](../../data-source-procedures/cloud-audit-log-investigation.md)
- [Cloud Network Flow Analysis](../../data-source-procedures/cloud-network-flow-analysis.md)

### Investigation Steps

1. **Lock Resource for Forensic Analysis**
   - Follow the [AWS resources lock SOP](https://canvadev.atlassian.net/wiki/spaces/CDR/pages/2984476860/AWS+resources+lock) for AWS resources
   - For GCP resources, implement appropriate access controls to prevent modification
   - Document the timestamp and method of resource locking
   - Notify relevant stakeholders of temporary access restrictions
   - Expected outcome: Resource is secured against modification during investigation

2. **Analyze Forensic Data Collection**
   - Review the forensics package automatically collected by Wiz, containing:
     - System logs and artifacts
     - File metadata and timestamps
     - Process execution history
     - Network connection logs
   - Examine the full disk volume snapshot in the canva-forensics AWS account
   - Extract the suspicious file for deeper analysis if necessary
   - Expected outcome: Comprehensive understanding of the malware and its behavior

3. **Determine Execution Status and Impact**
   - Analyze logs to confirm if the malware successfully executed
   - Look for evidence of persistence mechanisms (startup items, scheduled tasks, etc.)
   - Check for unusual network connections or data transfer
   - Assess unauthorized activity scope by reviewing available logs
   - Expected outcome: Confirmation of execution status and impact assessment

4. **Identify Infection Vector**
   - Review deployment and configuration changes prior to detection
   - Check for vulnerable components or misconfigurations
   - Analyze user activity and access patterns
   - Investigate potential supply chain compromise
   - Expected outcome: Identification of how the malware entered the environment

## Containment

### Containment Strategy

Isolate affected resources to prevent lateral movement and further compromise while preserving forensic evidence.

### Containment Steps

1. **Network Containment**
   - Immediately network-contain affected resources using appropriate method for the cloud provider:
     - For EC2 instances: Follow the [Isolate EC2 Instance SOP](https://canvadev.atlassian.net/wiki/spaces/CDR/pages/2107475092/Isolate+EC2+Instance)
     - For GCP workloads: Follow the [Isolate GCP Cloud Workloads SOP](https://canvadev.atlassian.net/wiki/spaces/CDR/pages/3035269555/Isolate+GCP+Cloud+Workloads)
   - Document all containment actions and timestamps
   - Expected outcome: Affected resource is isolated from the network

2. **Access Restriction**
   - Implement additional access controls to prevent unauthorized modification
   - Revoke active access tokens or credentials if compromise is suspected
   - Document all access changes and affected users
   - Expected outcome: Resource is secured against unauthorized access

3. **Stakeholder Notification**
   - Notify the resource owners about the compromise
   - Communicate the impact of containment measures
   - Provide estimated timeline for investigation and remediation
   - Expected outcome: All stakeholders are informed with appropriate context

## Eradication

### Eradication Strategy

Remove malware and address vulnerabilities that enabled the compromise while ensuring thorough cleanup of all affected resources.

### Eradication Steps

1. **Identify and Remove Malware Components**
   - Search for and identify all malware artifacts
   - Remove malicious files, processes, and associated components
   - Document all removed items and their locations
   - Expected outcome: All malicious components are removed

2. **Address Vulnerabilities**
   - Search for and identify vulnerabilities that contributed to the compromise
   - Involve AppSec team as required for vulnerability assessment
   - Apply necessary patches or configuration changes
   - Document all vulnerability remediations
   - Expected outcome: Vulnerabilities that enabled the compromise are addressed

3. **Eliminate Persistence Mechanisms**
   - Identify all persistence mechanisms established by the malware
   - Remove unauthorized startup items, scheduled tasks, or services
   - Check for backdoor accounts or modified permissions
   - Verify removal of all persistence methods
   - Expected outcome: All persistence mechanisms are eliminated

## Recovery

### Recovery Strategy

Restore secure operations with improved controls to prevent similar incidents in the future.

### Recovery Steps

1. **Deploy Clean Resources**
   - Scale up new, clean resources as required
   - Rebuild affected systems from verified secure images or templates
   - Implement improved security controls during deployment
   - Coordinate with owning teams to restore functionality
   - Expected outcome: Clean resources deployed with appropriate security controls

2. **Verify Security Posture**
   - Run full security scans on new resources
   - Verify proper configuration and patching
   - Confirm that no malicious elements persist
   - Implement additional monitoring for similar threats
   - Expected outcome: Resources are confirmed to be secure

3. **Restore Normal Operations**
   - Coordinate with resource owners to verify functionality
   - Monitor performance and behavior during initial operation
   - Implement phased approach to production traffic if necessary
   - Document lessons learned for future prevention
   - Expected outcome: Operations are restored with improved security

## Post-Incident Activities

### Lessons Learned

Reference the [Post-Incident Review Process](../../sops/post-incident-review-sop.md) for conducting a comprehensive review.

### Key Metrics to Collect

- Time to detection from initial compromise
- Time to containment after detection
- Number of affected resources
- Type of malware involved
- Initial infection vector
- Effectiveness of security controls

### Detection Improvement

- Review Wiz detection rules based on findings
- Improve scanning coverage or frequency if needed
- Update malware signatures or detection patterns
- Enhance correlation between cloud security platforms

## Additional Resources

- [Internal Forensics SOPs](https://canvadev.atlassian.net/wiki/spaces/CDR/pages/2685927483/Forensics)
- [Wiz Forensics Documentation](https://docs.wiz.io/wiz-docs/docs/forensics)
- [Isolate EC2 Instance SOP](https://canvadev.atlassian.net/wiki/spaces/CDR/pages/2107475092/Isolate+EC2+Instance)
- [Isolate GCP Cloud Workloads](https://canvadev.atlassian.net/wiki/spaces/CDR/pages/3035269555/Isolate+GCP+Cloud+Workloads)

## Related Artifacts

- [Cloud Malware Analysis Guidelines](../../artifact-guidelines/cloud-malware-analysis-guidelines.md)
- [Cloud Workload Security Standards](../../artifact-guidelines/cloud-workload-security-standards.md)
- [Forensic Data Collection Guidelines](../../artifact-guidelines/forensic-data-collection-guidelines.md)